<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h2>My Profile</h2>
    <div id="profile-view">
      <img id="profile-picture" class="profile-picture" src="default-profile.png" alt="Profile Picture" style="width:100px; height:100px; border-radius:50%; object-fit:cover;">
      <label for="upload-profile-picture">Change Profile Picture:</label>
      <input type="file" id="upload-profile-picture" accept="image/*">
      <p><b>Username:</b> <span id="username">Loading...</span></p>
      <p><b>About Me:</b> <span id="about">Not set</span></p>
      <p><b>Fitness Goals:</b> <span id="fitness-goals">Not set</span></p>
      <button id="edit-profile-btn">Edit Profile</button>
    </div>

    <div id="profile-edit" style="display: none;">
      <h3>Edit Profile</h3>
      <label for="edit-about">About Me:</label>
      <textarea id="edit-about"></textarea>

      <label for="edit-goals">Fitness Goals:</label>
      <textarea id="edit-goals"></textarea>

      <button id="save-profile-btn">Save Changes</button>
      <button id="cancel-edit-btn">Cancel</button>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const token = localStorage.getItem("token");

      if (!token) {
        alert("You are not logged in!");
        window.location.href = "index.html";
        return;
      }

      // Fetch profile details
      const response = await fetch("https://fitknight-01ae.onrender.com/users/profile", {
        headers: { Authorization: `Bearer ${token}` },
      });

      const user = await response.json();
      if (user) {
        document.getElementById("profile-picture").src = user.profilePicture || "default-profile.png";
        document.getElementById("username").textContent = user.username || "Unknown";
        document.getElementById("about").textContent = user.about || "Not set";
        document.getElementById("fitness-goals").textContent = user.fitnessGoals || "Not set";
      }

      // Save profile changes
      document.getElementById("save-profile-btn").addEventListener("click", async () => {
        const about = document.getElementById("edit-about").value;
        const fitnessGoals = document.getElementById("edit-goals").value;

        const response = await fetch("https://fitknight-01ae.onrender.com/users/profile", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ about, fitnessGoals }),
        });

        const result = await response.json();
        if (result.success) {
          alert("Profile updated successfully!");
          window.location.reload();
        } else {
          alert("Failed to update profile.");
        }
      });

      // Upload profile picture
      document.getElementById("upload-profile-picture").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("profilePicture", file);

        const response = await fetch("https://fitknight-01ae.onrender.com/users/upload-profile-picture", {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        });

        const result = await response.json();
        if (result.success) {
          alert("Profile picture updated successfully!");
          window.location.reload();
        } else {
          alert("Failed to update profile picture.");
        }
      });
    });
  </script>
</body>
</html>
